{"version":3,"file":"index.js","sources":["../../src/deep-computed-observer.ts","../../src/deep-computed-expression.ts","../../src/index.ts"],"sourcesContent":["import {\r\n  ObserverLocator,\r\n  subscriberCollection,\r\n  ICollectionObserverSplice,\r\n  connectable as $connectable,\r\n  Scope,\r\n  createOverrideContext,\r\n  Binding,\r\n  Disposable\r\n} from 'aurelia-binding';\r\nimport {\r\n  ICallable,\r\n  IPropertyObserver,\r\n  ICollectionObserver\r\n} from './definitions';\r\nimport { ComputedExpression } from './deep-computed-expression';\r\n\r\n// a deep observer needsd to be able to\r\n// - observe all properties, recursively without boundary\r\n// - detect a path of observer change\r\n\r\n/**\r\n * @internal The interface describes methods added by `connectable` & `subscriberCollection` decorators\r\n */\r\nexport interface DeepComputedObserver extends Binding {\r\n  _version: number;\r\n  addSubscriber(callable: (...args: any[]) => void): boolean;\r\n  addSubscriber(context: string, callable: ICallable): boolean;\r\n  addSubscriber(context: string | ICallable, callable?: ICallable): boolean;\r\n  callSubscribers(newValue: any, oldValue?: any): void;\r\n  hasSubscriber(context: string | ICallable, callable?: ICallable): boolean;\r\n  hasSubscribers(): boolean;\r\n  removeSubscriber(context: string | ICallable, callable?: ICallable): boolean;\r\n  observe(): void;\r\n  unobserve(all?: boolean): void;\r\n}\r\n\r\n// it looks better using @...(), so we cast to any instead of ClassDecorator\r\n// aurelia decorators support both usage: with and without parens\r\nconst connectable = $connectable as any;\r\n\r\n// by default, it does not support value converters & binding behaviors in the expressions\r\n// but maybe it should. TODO\r\nconst emptyLookupFunctions = {\r\n  valueConverters: name => null,\r\n  bindingBehaviors: name => null,\r\n};\r\n\r\nconst unset = {};\r\n\r\nexport class DeepComputedObserver {\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  private isQueued: boolean = false;\r\n  /**\r\n   * @internal\r\n   */\r\n  private oldValue: any = unset;\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  private rootDeps: IDependency[];\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  private readonly scope: Scope;\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  private readonly notifyingDeps: IDependency[] = [];\r\n\r\n  constructor(\r\n    public obj: object,\r\n    /**\r\n     * The expression that will be used to evaluate \r\n     */\r\n    // this expression has 2 purposes:\r\n    //  - a thin layer wrapping around getting/setting value of the targeted computed property\r\n    //  - an abstraction for dealing with a list of declared dependencies and their corresponding value\r\n    //    that uses existing Aurelia binding capabilities\r\n    public expression: ComputedExpression,\r\n    public observerLocator: ObserverLocator\r\n  ) {\r\n    this.scope = { bindingContext: obj, overrideContext: createOverrideContext(obj) };\r\n  }\r\n\r\n  getValue(): any {\r\n    return this.expression.evaluate(this.scope, emptyLookupFunctions);\r\n  }\r\n\r\n  setValue(newValue: any): void {\r\n    this.expression.assign(this.scope, newValue, emptyLookupFunctions);\r\n  }\r\n\r\n  subscribe(context: (...args: any[]) => any): Disposable;\r\n  subscribe(context: string | ICallable, callable?: ICallable): void | Disposable {\r\n    if (!this.hasSubscribers()) {\r\n      this.oldValue = this.expression.evaluate(this.scope, emptyLookupFunctions);\r\n      this.expression.connect(\r\n        /* @connectable makes this class behave as Binding */this,\r\n        this.scope\r\n      );\r\n      this.observeDeps();\r\n    }\r\n    this.addSubscriber(context, callable);\r\n    // scenario where this observer is created manually via ObserverLocator.getObserver\r\n    if (arguments.length === 1 && typeof context === 'function') {\r\n      return {\r\n        dispose: () => {\r\n          this.unsubscribe(context, callable);\r\n        }\r\n      };\r\n    }\r\n  }\r\n\r\n  unsubscribe(context: string | ICallable, callable?: ICallable): void {\r\n    if (this.removeSubscriber(context, callable) && !this.hasSubscribers()) {\r\n      this.unobserveDeps();\r\n      this.unobserve(true);\r\n      this.oldValue = unset;\r\n      this.notifyingDeps.length = 0;\r\n    }\r\n  }\r\n\r\n  call() {\r\n    let newValue = this.expression.evaluate(this.scope, emptyLookupFunctions);\r\n    let oldValue = this.oldValue;\r\n    if (newValue !== oldValue) {\r\n      this.oldValue = newValue;\r\n      this.callSubscribers(newValue, oldValue);\r\n    }\r\n    if (this.isQueued) {\r\n      this.notifyingDeps.forEach(dep => {\r\n        if (!dep.connected) {\r\n          return;\r\n        }\r\n        dep.release();\r\n        dep.collect();\r\n        dep.observe();\r\n      });\r\n      this.isQueued = false;\r\n    } else {\r\n      this.unobserveDeps();\r\n      this.observeDeps();\r\n    }\r\n    this.notifyingDeps.length = 0;\r\n    this._version++;\r\n    this.expression.connect(/* @connectable makes this class behave as Binding */this, this.scope);\r\n    this.unobserve(false);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  handleChange(dep: IDependency, collect: boolean): void {\r\n    if (this.isQueued) {\r\n      return;\r\n    }\r\n    if (this.notifyingDeps.indexOf(dep) === -1) {\r\n      this.notifyingDeps.push(dep);\r\n    }\r\n    this.observerLocator.taskQueue.queueMicroTask(this);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  private observeDeps(): void {\r\n    const values = this.expression.getDeps(this.scope);\r\n    let rootDeps = this.rootDeps;\r\n    if (rootDeps == null) {\r\n      rootDeps = this.rootDeps = values.map(v => getDependency(this, null, v)).filter(Boolean);\r\n    }\r\n    rootDeps.forEach(dep => {\r\n      dep.collect();\r\n      dep.observe();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  private unobserveDeps(): void {\r\n    const rootDeps = this.rootDeps;\r\n    if (rootDeps != null) {\r\n      rootDeps.forEach(releaseDep);\r\n      this.rootDeps = void 0;\r\n    }\r\n  }\r\n}\r\n\r\n// use this instead of decorator to avoid extra generated code\r\nconnectable()(DeepComputedObserver);\r\nsubscriberCollection()(DeepComputedObserver);\r\n\r\nexport interface IDependency {\r\n  /**\r\n   * Root observer/dep of this dep\r\n   */\r\n  owner: DeepComputedObserver;\r\n  /**\r\n   * The parent dep of this dep. Represents the owner object of the object associated with this dep\r\n   */\r\n  parent: IDependency | null;\r\n  /**\r\n   * The sub dependencies of this dependency\r\n   */\r\n  deps: Map<unknown, IDependency>;\r\n  /**\r\n   * Indicates whther the dependency is observing\r\n   */\r\n  connected: boolean;\r\n  /**\r\n   * collect sub dependencies of this dependency value\r\n   */\r\n  collect(): void;\r\n  /**\r\n   * Start observing: Connect all sub dependencies to the root observer\r\n   */\r\n  observe(): void;\r\n  /**\r\n   * Release all sub dependencies of this dependency\r\n   */\r\n  release(): void;\r\n}\r\n\r\nconst releaseDep = (dep: IDependency) => {\r\n  dep.release();\r\n};\r\nconst observeDep = (dep: IDependency) => {\r\n  dep.observe();\r\n}\r\n\r\n// for Aurelia binding subscriber, a context is required if it's not a function\r\nconst objectPropDepContext = 'context:object_prop_dep';\r\nconst arrayDepContext = 'context:array_dep';\r\n\r\nclass ObjectDependency implements IDependency {\r\n\r\n  deps: Map<string | number, IDependency> = new Map();\r\n  connected: boolean = false;\r\n\r\n  constructor(\r\n    public owner: DeepComputedObserver,\r\n    public parent: IDependency | null,\r\n    public value: object\r\n  ) { }\r\n\r\n  collect(): void {\r\n    const value = this.value;\r\n    Object.keys(value).forEach(prop => {\r\n      const propertyDep = new ObjectPropertyDependency(this.owner, this, prop, value[prop]);\r\n      this.deps.set(prop, propertyDep);\r\n      propertyDep.collect();\r\n    });\r\n  }\r\n\r\n  observe() {\r\n    this.deps.forEach(observeDep);\r\n    this.connected = true;\r\n  }\r\n\r\n  release(): void {\r\n    this.deps.forEach(releaseDep);\r\n    this.connected = false;\r\n  }\r\n}\r\n\r\nclass ObjectPropertyDependency implements IDependency {\r\n  deps = new Map<any, IDependency>();\r\n\r\n  observer: IPropertyObserver;\r\n\r\n  connected: boolean = false;\r\n\r\n  constructor(\r\n    public owner: DeepComputedObserver,\r\n    public parent: ObjectDependency,\r\n    public property: string,\r\n    public value: any\r\n  ) {\r\n\r\n  }\r\n\r\n  collect(): void {\r\n    const valueDep = getDependency(this.owner, this, this.value);\r\n    if (valueDep == null) {\r\n      return;\r\n    }\r\n    this.deps.set(this, valueDep);\r\n    valueDep.collect();\r\n  }\r\n\r\n  observe(): void {\r\n    let observer = this.observer;\r\n    if (observer == null) {\r\n      observer\r\n        = this.observer\r\n        = this\r\n          .owner\r\n          .observerLocator\r\n          .getObserver(this.parent.value, this.property);\r\n    }\r\n\r\n    observer.subscribe(objectPropDepContext, this);\r\n    this.deps.forEach(observeDep);\r\n    this.connected = true;\r\n  }\r\n\r\n  release(): void {\r\n    const observer = this.observer;\r\n    if (observer != null) {\r\n      observer.unsubscribe(objectPropDepContext, this);\r\n      this.observer = void 0;\r\n    }\r\n    this.deps.forEach(releaseDep);\r\n    this.deps.clear();\r\n    this.connected = false;\r\n  }\r\n\r\n  call(): void {\r\n    // when property change\r\n    // 1. release all sub-deps\r\n    this.release();\r\n    // 2. re-evaluate the value\r\n    this.value = this.parent.value[this.property];\r\n    // 3. re-collect deps\r\n    this.collect();\r\n    this.observe();\r\n    // 4. notify the owner\r\n    this.owner.handleChange(this, /* should recollect everything? */false);\r\n  }\r\n}\r\n\r\nclass ArrayDependency implements IDependency {\r\n  deps: Map<string | number, IDependency> = new Map();\r\n\r\n  observer: ICollectionObserver;\r\n  connected: boolean = false;\r\n\r\n  constructor(\r\n    public owner: DeepComputedObserver,\r\n    public parent: IDependency | null,\r\n    public value: any[],\r\n  ) { }\r\n\r\n  collect(): void {\r\n    for (let i = 0, arr = this.value, ii = arr.length; ii > i; ++i) {\r\n      let value = arr[i];\r\n      const dep = getDependency(this.owner, this, value);\r\n      // if an index is not observable\r\n      // just ignore\r\n      if (dep == void 0) {\r\n        return;\r\n      }\r\n      this.deps.set(i, dep);\r\n      dep.collect();\r\n    }\r\n  }\r\n\r\n  observe() {\r\n    let observer = this.observer;\r\n    if (observer == null) {\r\n      observer\r\n        = this.observer\r\n        = this\r\n          .owner\r\n          .observerLocator\r\n          .getArrayObserver(this.value);\r\n    }\r\n\r\n    observer.subscribe(arrayDepContext, this);\r\n\r\n    this.deps.forEach(observeDep);\r\n    this.connected = true;\r\n  }\r\n\r\n  release(): void {\r\n    const observer = this.observer;\r\n    if (observer != null) {\r\n      observer.unsubscribe(arrayDepContext, this);\r\n      this.observer = void 0;\r\n    }\r\n    this.deps.forEach(releaseDep);\r\n    this.deps.clear();\r\n    this.connected = false;\r\n  }\r\n\r\n  call(changeRecords: ICollectionObserverSplice[]): void {\r\n    // when array is mutated\r\n    // 1. release\r\n    this.release();\r\n    // 2. recollect\r\n    this.collect();\r\n    this.observe();\r\n    // 3. notify owner\r\n    this.owner.handleChange(this, true);\r\n  }\r\n}\r\n\r\nclass SetDependency implements IDependency {\r\n  deps: Map<string | number, IDependency> = new Map();\r\n  connected: boolean = false;\r\n\r\n  constructor(\r\n    public owner: DeepComputedObserver,\r\n    public parent: IDependency | null,\r\n    public set: Set<any>,\r\n  ) { }\r\n\r\n  collect(): void {\r\n    this.set.forEach(value => {\r\n      const dep = getDependency(this.owner, this, value);\r\n      if (dep == void 0) {\r\n        return;\r\n      }\r\n      dep.collect();\r\n      // incorrect to typings, but safe\r\n      this.deps.set(value as any, dep);\r\n    });\r\n  }\r\n\r\n  observe(): void {\r\n    this.deps.forEach(observeDep);\r\n    this.connected = true;\r\n  }\r\n\r\n  release(): void {\r\n    this.deps.forEach(releaseDep);\r\n    this.deps.clear();\r\n    this.connected = false;\r\n  }\r\n}\r\n\r\nconst dependencyMap = new WeakMap();\r\nconst raw2Dep = new WeakMap();\r\n\r\nfunction getDependency(owner: DeepComputedObserver, parent: IDependency, value: unknown): IDependency {\r\n  const valueType = typeof value;\r\n  if (value == null || valueType === 'boolean' || valueType === 'number' || valueType === 'string' || valueType === 'symbol' || valueType === 'bigint' || typeof value === 'function') {\r\n    return;\r\n  }\r\n  if (Array.isArray(value)) {\r\n    return new ArrayDependency(owner, parent, value);\r\n  }\r\n\r\n  if (value instanceof Set) {\r\n    return new SetDependency(owner, parent, value);\r\n  }\r\n\r\n  return new ObjectDependency(owner, parent, value as object);\r\n}\r\n","import { Expression, Scope, Binding } from \"aurelia-binding\";\r\n\r\nexport class ComputedExpression extends Expression {\r\n\r\n  // this is to signal aurelia binding that it's ok trying to invoke .assign on this expression\r\n  isAssignable: boolean = true;\r\n\r\n  constructor(\r\n    public readonly name: string,\r\n    public readonly dependencies: Expression[]\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  evaluate(scope: Scope, lookupFunctions: any) {\r\n    return scope.bindingContext[this.name];\r\n  }\r\n\r\n  assign(scope: Scope, value: any, lookupFunctions: any): void {\r\n    scope.bindingContext[this.name] = value;\r\n  }\r\n\r\n  accept(visitor: any) {\r\n    throw new Error('not implemented');\r\n  }\r\n\r\n  connect(binding: Binding, scope: Scope) {\r\n    let dependencies = this.dependencies;\r\n    let i = dependencies.length;\r\n    while (i--) {\r\n      dependencies[i].connect(binding, scope);\r\n    }\r\n  }\r\n\r\n  getDeps(scope: Scope): any[] {\r\n    return this.dependencies.map(dep => dep.evaluate(scope));\r\n  }\r\n}","import {\r\n  FrameworkConfiguration,\r\n} from 'aurelia-framework';\r\nimport {\r\n  ObserverLocator,\r\n  Parser,\r\n  InternalPropertyObserver,\r\n} from 'aurelia-binding';\r\nimport { DeepComputedFromPropertyDescriptor } from './definitions';\r\nimport { DeepComputedObserver } from './deep-computed-observer';\r\nimport { ComputedExpression } from './deep-computed-expression';\r\n\r\nexport {\r\n  DeepComputedObserver,\r\n  IDependency\r\n} from './deep-computed-observer';\r\n\r\nexport function configure(config: FrameworkConfiguration): void {\r\n  // need to run at post task to ensure we don't resolve everything too early\r\n  config.postTask(() => {\r\n    const observerLocator = config.container.get(ObserverLocator);\r\n    const parser = config.container.get(Parser);\r\n    observerLocator.addAdapter({\r\n      getObserver: (obj, propertyName, descriptor: DeepComputedFromPropertyDescriptor): InternalPropertyObserver => {\r\n        if (descriptor.get.deep) {\r\n          return createComputedObserver(obj, propertyName, descriptor, observerLocator, parser);\r\n        }\r\n        return null;\r\n      }\r\n    })\r\n  });\r\n}\r\n\r\nexport function deepComputedFrom(...expressions: string[]) {\r\n  return function (target: any, key: any, descriptor: PropertyDescriptor) {\r\n    const $descriptor = descriptor as DeepComputedFromPropertyDescriptor;\r\n    const getterFn = $descriptor.get;\r\n    getterFn.deep = true;\r\n    getterFn.deps = expressions;\r\n    getterFn.computedExpression = void 0;\r\n    return descriptor;\r\n  } as MethodDecorator;\r\n}\r\n\r\nfunction createComputedObserver(\r\n  obj: any,\r\n  propertyName: string,\r\n  descriptor: DeepComputedFromPropertyDescriptor,\r\n  observerLocator: ObserverLocator,\r\n  parser: Parser\r\n) {\r\n  let computedExpression = descriptor.get.computedExpression;\r\n  if (!(computedExpression instanceof ComputedExpression)) {\r\n    let dependencies = descriptor.get.deps;\r\n    let i = dependencies.length;\r\n    const parsedDeps = descriptor.get.parsedDeps = Array(dependencies.length);\r\n    while (i--) {\r\n      parsedDeps[i] = parser.parse(dependencies[i]);\r\n    }\r\n    computedExpression = descriptor.get.computedExpression = new ComputedExpression(propertyName, parsedDeps);\r\n  }\r\n\r\n  return new DeepComputedObserver(obj, computedExpression, observerLocator);\r\n}\r\n"],"names":["$connectable"],"mappings":"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"}